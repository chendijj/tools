<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>功能单据分类工具 - Tools Collection</title>
    <!-- 引入主题样式 -->
    <link rel="stylesheet" href="../shared/theme.css">
</head>
<body>
    <div class="min-h-screen" style="background-color: var(--bg-primary)">
        <div class="app-container">
            <!-- 标题栏 -->
            <header class="header">
                <div class="title-bar">
                    <div class="title-left">
                        <span class="icon">📋</span>
                        <h1>功能单据分类工具</h1>
                    </div>
                    <div class="theme-toggle">
                        <button onclick="toggleTheme()" title="切换主题">
                            <span id="themeIcon">🌙</span>
                        </button>
                    </div>
                </div>
            </header>

            <!-- 主要内容区域 -->
            <main style="padding: 20px">
                <div class="animate-fadeIn" style="display: flex; flex-direction: column; gap: 20px">

                    <!-- 工具栏 -->
                    <div class="toolbar">
                        <div class="toolbar-content">
                            <div class="toolbar-group">
                                <button onclick="processDocument()" class="tool-button primary">
                                    <span>🔄</span>
                                    处理文档
                                </button>
                                <button onclick="loadExample(); processDocument();" class="tool-button">
                                    <span>📊</span>
                                    加载示例
                                </button>
                            </div>
                            <div class="toolbar-group">
                                <button onclick="copyResult()" class="tool-button success">
                                    <span>📋</span>
                                    复制结果
                                </button>
                                <button onclick="clearAll()" class="tool-button danger">
                                    <span>🗑️</span>
                                    清空
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 主要内容区域 -->
                    <div class="input-output-grid">
                        <!-- 输入区域 -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <span>📝</span>
                                    输入文档
                                </h3>
                            </div>
                            <div class="card-body">
                                <textarea
                                    id="input"
                                    class="form-control monospace"
                                    style="height: 400px;"
                                    placeholder="请在此处粘贴您的功能单据文本...

支持格式：
【类别】功能名称
或者
普通功能名称（将归类到"其他"）"
                                ></textarea>
                            </div>
                        </div>

                        <!-- 输出区域 -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <span>📊</span>
                                    分类结果
                                </h3>
                            </div>
                            <div class="card-body">
                                <textarea
                                    id="output"
                                    class="form-control monospace"
                                    style="height: 400px;"
                                    readonly
                                    placeholder="处理后的分类结果将在此显示..."
                                ></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- 统计信息 -->
                    <div class="stats" id="stats" style="display: none;">
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-number" id="totalCategories">0</div>
                                <div class="stat-label">类别数量</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" id="totalFunctions">0</div>
                                <div class="stat-label">功能总数</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" id="categorizedFunctions">0</div>
                                <div class="stat-label">已分类功能</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" id="otherFunctions">0</div>
                                <div class="stat-label">其他功能</div>
                            </div>
                        </div>
                    </div>

                </div>
            </main>

        </div>
    </div>

    <!-- Toast通知 -->
    <div class="toast" id="toast"></div>

    <!-- 引入主题脚本 -->
    <script src="../shared/theme.js"></script>
    
    <!-- 工具专有脚本 -->
    <script>
        function processDocument() {
            const input = document.getElementById('input').value.trim();
            if (!input) {
                ToastManager.error('请先输入文档内容');
                return;
            }

            try {
                const result = processFunctionDocuments(input);
                document.getElementById('output').value = result.output;
                updateStats(result.stats);
                ToastManager.success('文档处理完成！');
            } catch (error) {
                ToastManager.error('处理失败：' + error.message);
            }
        }

        // 关键词映射表，用于合并相似类别
        function createKeywordMap(categories) {
            const keywordMap = {};
            const categoryKeys = Object.keys(categories);
            
            for (let i = 0; i < categoryKeys.length; i++) {
                const category1 = categoryKeys[i];
                let mergeTarget = category1;
                
                // 查找是否有其他类别是当前类别的子集
                for (let j = 0; j < categoryKeys.length; j++) {
                    if (i !== j) {
                        const category2 = categoryKeys[j];
                        // 如果category1包含category2，则将category2合并到category1
                        if (category1.includes(category2) && category2.length < category1.length) {
                            mergeTarget = category2;
                            break;
                        }
                        // 如果category2包含category1，则将category1合并到category2
                        else if (category2.includes(category1) && category1.length < category2.length) {
                            mergeTarget = category2;
                            break;
                        }
                    }
                }
                keywordMap[category1] = mergeTarget;
            }
            
            return keywordMap;
        }

        // 从文本中提取关键词进行分类
        function extractKeywordsFromText(text) {
            // 常见关键词模式
            const keywordPatterns = {
                '英雄': ['英雄', '角色', '人物'],
                '装备': ['装备', '武器', '道具', '物品'],
                '关卡': ['关卡', '副本', '战斗', 'boss', 'pve', '挑战'],
                '系统': ['系统', '功能', '设置', '配置'],
                'GM': ['gm', '管理', '后台', '工具'],
                '演习': ['演习', '竞技', 'pvp', '对战'],
                '建筑': ['建筑', '升级', '建造'],
                '怪物': ['怪物', '野怪', '敌人']
            };
            
            const textLower = text.toLowerCase();
            
            // 查找匹配的关键词
            for (const [category, patterns] of Object.entries(keywordPatterns)) {
                for (const pattern of patterns) {
                    if (textLower.includes(pattern)) {
                        return category;
                    }
                }
            }
            
            return null;
        }

        function processFunctionDocuments(content) {
            // 使用正则表达式匹配功能单据
            const pattern = /【(.*?)】([^\n]+)/g;
            const matches = [];
            let match;
            
            while ((match = pattern.exec(content)) !== null) {
                matches.push({
                    category: match[1].trim(),
                    functionName: match[2].trim()
                });
            }

            // 按类别分类
            const categories = {};
            
            // 处理有【】符号的功能单据
            matches.forEach(({ category, functionName }) => {
                if (!categories[category]) {
                    categories[category] = [];
                }
                categories[category].push(functionName);
            });

            // 创建关键词映射进行类别合并
            const keywordMap = createKeywordMap(categories);
            const mergedCategories = {};
            
            // 合并相似类别
            Object.entries(categories).forEach(([category, functions]) => {
                const targetCategory = keywordMap[category];
                if (!mergedCategories[targetCategory]) {
                    mergedCategories[targetCategory] = [];
                }
                mergedCategories[targetCategory] = mergedCategories[targetCategory].concat(functions);
            });

            // 提取没有【】符号的行并尝试自动分类
            const lines = content.split('\n');
            const unclassifiedFunctions = [];
            
            lines.forEach(line => {
                line = line.trim();
                if (line && !line.match(/【.*?】/)) {
                    // 检查是否已经被匹配过（避免重复）
                    const isMatched = matches.some(({ functionName }) => 
                        line === functionName.trim()
                    );
                    if (!isMatched) {
                        // 尝试基于关键词自动分类
                        const detectedCategory = extractKeywordsFromText(line);
                        if (detectedCategory) {
                            if (!mergedCategories[detectedCategory]) {
                                mergedCategories[detectedCategory] = [];
                            }
                            mergedCategories[detectedCategory].push(line);
                        } else {
                            unclassifiedFunctions.push(line);
                        }
                    }
                }
            });

            // 添加未能分类的功能到"其他"类别
            if (unclassifiedFunctions.length > 0) {
                mergedCategories['其他'] = unclassifiedFunctions;
            }

            // 生成格式化输出
            const outputLines = [];
            let totalFunctions = 0;
            let categorizedFunctions = 0;

            Object.entries(mergedCategories).forEach(([category, functions]) => {
                // 添加类别标题
                outputLines.push(`${category}及其子功能单据${functions.length}个`);
                
                // 添加序号功能列表
                functions.forEach((func, index) => {
                    if (category === '其他') {
                        outputLines.push(` ${index + 1}、${func}`);
                    } else {
                        outputLines.push(` ${index + 1}、【${category}】${func}`);
                        categorizedFunctions++;
                    }
                });
                
                // 添加空行分隔
                outputLines.push('');
                totalFunctions += functions.length;
            });

            // 移除最后的空行
            if (outputLines.length > 0 && outputLines[outputLines.length - 1] === '') {
                outputLines.pop();
            }

            const stats = {
                totalCategories: Object.keys(mergedCategories).length,
                totalFunctions: totalFunctions,
                categorizedFunctions: categorizedFunctions,
                otherFunctions: unclassifiedFunctions.length
            };

            return {
                output: outputLines.join('\n'),
                stats: stats
            };
        }

        function updateStats(stats) {
            document.getElementById('totalCategories').textContent = stats.totalCategories;
            document.getElementById('totalFunctions').textContent = stats.totalFunctions;
            document.getElementById('categorizedFunctions').textContent = stats.categorizedFunctions;
            document.getElementById('otherFunctions').textContent = stats.otherFunctions;
            document.getElementById('stats').style.display = 'block';
        }

        function clearAll() {
            document.getElementById('input').value = '';
            document.getElementById('output').value = '';
            document.getElementById('stats').style.display = 'none';
            ToastManager.success('已清空所有内容');
        }

        async function copyResult() {
            const output = document.getElementById('output').value;
            if (!output) {
                ToastManager.error('没有可复制的内容');
                return;
            }

            const success = await Utils.copyToClipboard(output);
            if (success) {
                ToastManager.success('结果已复制到剪贴板！');
            } else {
                ToastManager.error('复制失败');
            }
        }

// 示例数据加载
        function loadExample() {
            const exampleData = `【GM】PVETest关卡选择，需要支持读取pve_section_config
【英雄装备】替换装备的时候需要支持脱下后穿戴
【英雄装备】替换正在被其他英雄穿戴的装备时先弹出对比界面然后直接替换
【英雄部队】英雄队伍管理功能
【英雄】角色属性优化
【演习室】防守阵容推荐设置优化-预制
【演习室】防守阵容推荐设置优化-UI-推荐图标和位置
pveboss关战力推荐挑战，pve关卡卡点具体到每个boss
打野怪重伤率提升到千分之1
【GM】客户端增加协议录制、回放的功能
pve失败推荐，建筑升级前五章放到第一位
装备强化系统优化
武器升级界面改进`;
            
            document.getElementById('input').value = exampleData;
        }
    </script>
</body>
</html>